<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <title>Charts</title>
    <link rel="stylesheet" type="text/css" href="../css/tabulator.css" />
    <link rel="stylesheet" type="text/css" href="../css/chart.css" />


    <script type="text/javascript" src="./lib/Chart.js"></script>
    <script type="text/javascript" src="./lib/color-hash.js"></script>
    <script type="text/javascript" src="./lib/html2canvas.js"></script>
    <script type="text/javascript" src="./messages.js"></script>
    <script type="text/javascript" src="./lib/apexcharts.js"></script>
    <script type="text/javascript" src="./lib/chartjs-chart-box-and-violin-plot.js"></script>
    <script type="text/javascript" src="./lib/tabulator.js"></script>

</head>

<div id="all_tabs" class="controles">
    <div class="pestañas" id="grade_tabs">
        <input type="button" class="btn" id="btnLine" onclick='javaConnector.updateCharts("LINE");' />
        <input type="button" class="btn" id="btnRadar" onclick='javaConnector.updateCharts("RADAR");' />
        <input type="button" class="btn" id="btnBoxPlot" onclick='javaConnector.updateCharts("GENERAL_BOXPLOT");' />
        <input type="button" class="btn" id="btnBoxPlotGroup" onclick='javaConnector.updateCharts("GROUP_BOXPLOT");' />
        <input type="button" class="btn" id="btnViolin" onclick='javaConnector.updateCharts("GENERAL_VIOLIN");' />
        <input type="button" class="btn" id="btnViolinGroup" onclick='javaConnector.updateCharts("GROUP_VIOLIN");' />
        <input type="button" class="btn" id="btnCalificaciones"
            onclick='javaConnector.updateCharts("GRADE_REPORT_TABLE");' />
    </div>
    <div class="pestañas" id="log_tabs">
        <input type="button" class="btn" id="btnStackedBar" onclick='javaConnector.updateCharts("STACKED_BAR");' />
        <input type="button" class="btn" id="btnHeatmap" onclick='javaConnector.updateCharts("HEAT_MAP");' />
        <input type="button" class="btn" id="btnCumLine" onclick='javaConnector.updateCharts("CUM_LINE");' />
        <input type="button" class="btn" id="btnMeanDiff" onclick='javaConnector.updateCharts("MEAN_DIFF");' />
    </div>

    <div class="opciones">
        <input type="button" value="Leyenda" class="btn" id="btnLegend" onclick="javaConnector.hideLegend();" />
        <input type="button" value="Media General" class="btn" id="btnMean" onclick="showGeneralMean()" />
        <input type="button" class="btn" id="btnGroupMean" onclick="showGroupMean()" />
    </div>
</div>

<div id="chart-container" class="chart-container">
    <canvas id="myChart"></canvas>
</div>
<div id="apexchartsDiv"></div>
<div id="tabulatorDiv"></div>

<script type="text/javascript">
    //------------------------------------------Opciones para los graficos------------------------------------------------------------------

    Chart.defaults.global.animation.duration = 0;
    Chart.defaults.global.elements.line.fill = false;
    Chart.defaults.global.elements.line.tension = 0;
    Chart.defaults.global.maintainAspectRatio = false;
    Chart.defaults.global.hover.animationDuration = 0;
    Chart.defaults.global.legend.labels.usePointStyle = true;
    Chart.defaults.global.legend.position = "top";
    Chart.defaults.global.onClick = function (event, array) {
        let element = myChart.getElementsAtEventForMode(event, "point", { intersect: false });
        if (element.length > 0) {
            javaConnector.dataPointSelection(element[counter % element.length]._datasetIndex);
            counter++;
        }
    };

    Chart.defaults.scale.ticks.beginAtZero = true;
    Chart.defaults.scale.ticks.stepSize = 1;
    Chart.defaults.scale.ticks.suggestedMax = 10;
    Chart.defaults.scale.ticks.suggestedMin = 0;
    Chart.defaults.scale.autoSkip = true;

    var counter = 0;
    var height = "93%";

    var stackedbarOptions = {
        tab: "log_tabs",
        button: "btnStackedBar",
        typeGraph: "bar",

        tooltips: {
            position: 'nearest',
            mode: 'x',
            callbacks: {
                label: function (tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel *
                        100) / 100;
                },
                afterTitle: function (tooltipItem, data) {
                    //Despues del titulo ponemos el nombre y apellidos del usuario
                    return data.datasets[tooltipItem[0].datasetIndex].name;
                }
            }
        },
        scales: {
            yAxes: [{
                stacked: true,
                ticks: {
                    stepSize: 0,
                }
            }],
            //xAxes: [{
            //   ticks: {
            //     maxTicksLimit: 20
            //}
            // }]
        },
        legend: {
            labels: {
                filter: function (legendItem, chartData) {
                    //mostramos en la leyenda los que son lineas
                    return chartData.datasets[legendItem.datasetIndex].type == "line";
                } //filter
            } //labels
        }, //legend
        onClick: function (event, array) {
            let element = myChart.getElementAtEvent(event)[0];
            if (element) {

                javaConnector.dataPointSelection(myChart.data.datasets[element._datasetIndex].stack);
            }
        }

    }

    heatmapOptions = {
        tab: "log_tabs",
        button: "btnHeatmap",
        typeGraph: "heatmap",


        tooltip: {
            x: {
                show: true
            }
        },
        plotOptions: {
            heatmap: {
                enableShades: false,
                //shadeIntensity: 0.5,
                colorScale: {
                    ranges: [{
                        from: -1,
                        to: 0,
                        color: "#f78880",
                        name: "0"
                    }, {
                        from: 1,
                        to: 1,
                        color: "#f4e3ae",
                    }, {
                        from: 1,
                        to: 1,
                        color: "#fff033",

                    },

                    {
                        from: 1,
                        to: 1,
                        color: "#b5ff33",

                    }, {
                        from: 1,
                        to: 1,
                        color: "#38e330",

                    }, {
                        from: 2,
                        to: Number.POSITIVE_INFINITY,
                        color: "#67b92e",
                        name: "+" + (2)
                    }

                    ]
                }
            }
        },
        legend: {
            position: 'top'
        },
        chart: {
            type: "heatmap",
            events: {
                dataPointSelection: function (event, chartContext, config) {
                    javaConnector.dataPointSelection(config.w.config.series.length - 1 - config.seriesIndex);
                }
            },
            height: height,
            toolbar: {
                show: false,
            },
            animations: {
                enabled: false
            }
        },
        dataLabels: {
            formatter: function (val, opts) {
                if (val == 0) {
                    return "";
                }
                return val;
            },
            style: {
                colors: ["#000000"]
            }
        },
        colors: ["#00A100"],
        series: [],
        xaxis: {
            categories: []
        }
    };

    var cumLineOptions = {
        tab: "log_tabs",
        button: "btnCumLine",
        typeGraph: "line",
        scales: {
            yAxes: [
                {
                    ticks: {
                        stepSize: 0,
                    }
                }
            ]
        },
        tooltips: {
            callbacks: {
                label: function (tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel *
                        100) / 100;
                }
            }
        }


    };

    var meanDiffOptions = {
        tab: "log_tabs",
        button: "btnMeanDiff",
        typeGraph: "line",
        scales: {
            yAxes: [
                {
                    ticks: {
                        stepSize: 0
                    }
                }
            ]
        },
        tooltips: {
            callbacks: {
                label: function (tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel *
                        100) / 100;
                }
            }
        }


    };


    var lineOptions = {
        tab: "grade_tabs",
        button: "btnLine",
        typeGraph: "line",
    
    }

    var radarOptions = {
        tab: "grade_tabs",
        button: "btnRadar",
        typeGraph: "radar",
        scale: {
            gridLines: {
                color: ['red', 'red', 'red', 'red', 'green', 'green', 'green', 'green', 'green', 'green']
            }
        }

    } //options
    var boxplotOptions = {
        tab: "grade_tabs",
        button: "btnBoxPlot",
        typeGraph: "boxplot",

        tooltipDecimals: 2


    }

    var boxplotGroupOptions = {
        tab: "grade_tabs",
        button: "btnBoxPlotGroup",
        typeGraph: "boxplot",

        tooltipDecimals: 2,
    
    }


    var violinOptions = {
        tab: "grade_tabs",
        button: "btnViolin",
        typeGraph: "violin",

        tooltipDecimals: 2,
        scales: {
            yAxes: [
                {
                    ticks: {
                        min: 0

                    }
                }
            ]
        }

    }

    var violinGroupOptions = {
        tab: "grade_tabs",
        button: "btnViolinGroup",
        typeGraph: "violin",

        tooltipDecimals: 2,
        scales: {
            yAxes: [
                {
                    ticks: {
                        min: 0

                    }
                }
            ]
        }
    }

    var gradeReportTableOptions = {

        tab: "grade_tabs",
        button: "btnCalificaciones",
        invalidOptionWarnings: false,
        height: height,
        groupBy: "type",
        virtualDom: true,
        layout: "fitColumns", //fit columns to width of table (optional)
        rowClick: function (e, row) {
            javaConnector.dataPointSelection(row.getPosition());

        },
    }

    tabulatorProgressParams = {
        min: 0,
        max: 10,
        legend: true,
        legendAlign: "center",
        color: function (value) {
            if (value < 5) {
                return "#DC143C";
            }
            return "#2DC214";
        }
    }

    //------------------------------------------Variables globales-------------------------------------------------------------

    //
    var colorHash = new ColorHash();
    var ctx = document.getElementById('myChart');

    var myChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: []
        },
        options: lineOptions
    });

    var myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), heatmapOptions);
    myApexChart.render();

    var table = new Tabulator("#tabulatorDiv", gradeReportTableOptions);


    //------------------------------------------Funciones------------------------------------------------------------------


    function imageButton(id, value) {
        if (value) {
            document.getElementById(id).style.backgroundImage = 'url(./../img/visibility.png)';

        } else {
            document.getElementById(id).style.backgroundImage = 'url(./../img/visibility_off.png)';
        }
    }

    function displayLegendButton(value) {
        document.getElementById('btnLegend').style.display = value ? "inline" : "none";
    }

    function displayGroupButton(value) {
        document.getElementById('btnGroupMean').style.display = value ? "inline" : "none";
    }

    function displayGeneralButton(value) {
        document.getElementById('btnMean').style.display = value ? "inline" : "none";
    }

    function displayApexChart(value) {
        document.getElementById('apexchartsDiv').style.display = value ? "block" : "none";
    }
    function displayTabulator(value) {
        document.getElementById('tabulatorDiv').style.display = value ? "block" : "none";
    }


    function displayChartjs(value) {
        document.getElementById('chart-container').style.display = value ? "block" : "none";
    }



    function displayChartsButtons(div_id, type) {
        let tabs = document.getElementById(div_id);
        let children = tabs.children;
        for (i = 0; i < children.length; i++) {
            if (children[i].tagName == "INPUT") {
                children[i].style.display = type;
            }

        }
    }

    function disableTab(div_id, noDisable) {

        if (document.getElementById(noDisable).disabled == false) {
            let tabs = document.getElementById(div_id);
            let children = tabs.children;
            for (i = 0; i < children.length; i++) {
                if (children[i].tagName == "INPUT") {
                    children[i].disabled = false;
                }

            }
            document.getElementById(noDisable).disabled = true;
        }


    }


    function updateApexCharts(series, categories, options) {
        displayApexChart(true);
        displayChartjs(false);
        displayTabulator(false);


        disableTab(options.tab, options.button);

        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);

        options.series = series;
        options.xaxis.categories = categories;
        options.legend.show = javaConnector.getShowLegend();
        if (myApexChart.w.config.chart.type == options.typeGraph) {

            myApexChart.updateOptions(options);
        } else {

            myApexChart.destroy();
            myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), options);
            myApexChart.render();
        }
    }

    function updateChartjs(dataset, options) {
        displayApexChart(false);
        displayChartjs(true);
        displayTabulator(false);


        disableTab(options.tab, options.button);

        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);

        if (myChart.config.type == options.typeGraph) {
            myChart.data = dataset;
            myChart.options = options;
            myChart.update();
            myChart.options.legend.display = javaConnector.getShowLegend();
            myChart.update();
        } else {
            myChart.destroy();
            myChart = new Chart(ctx, {
                type: options.typeGraph,
                data: dataset,
                options: options
            });
        }

    }

    function updateTabulator(columns, tabledata, options) {

        displayApexChart(false);
        displayChartjs(false);
        displayTabulator(true);
        disableTab(options.tab, options.button);
        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);

        disableTab(options.tab, options.button);
        table.setColumns(columns);
        table.setData(tabledata).then(function () {
            table.redraw();
        })


    }



    function clearChartjs() {
        myChart.destroy();
        myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: []
            },
            options: stackedbarOptions
        });
    }


    function manageButtons(type) {


        displayChartsButtons("grade_tabs", type == "grade" ? "inline" : "none");
        displayChartsButtons("log_tabs", type == "log" ? "inline" : "none");

    }



    function changeYMax(max, useNegativeValues) {
        stackedbarOptions.scales.yAxes[0].ticks.suggestedMax = max;
        cumLineOptions.scales.yAxes[0].ticks.suggestedMax = max;
        meanDiffOptions.scales.yAxes[0].ticks.suggestedMax = max;
        meanDiffOptions.scales.yAxes[0].ticks.suggestedMin = -max;
        myChart.options.scales.yAxes[0].ticks.suggestedMax = max;
        if(useNegativeValues){
            myChart.options.scales.yAxes[0].ticks.suggestedMin = -max;
        }
        myChart.update();

        heatmapOptions.plotOptions.heatmap.colorScale.ranges = [{
            from: -1,
            to: 0,
            color: "#f78880",
            name: "0"
        }, {
            from: 1,
            to: Math.max(Math.floor(max * 0.25), 1),
            color: "#f4e3ae",
        }, {
            from: Math.max(Math.ceil(max * 0.25), 1),
            to: Math.max(Math.floor(max * 0.50), 1),
            color: "#fff033",

        },

        {
            from: Math.max(Math.ceil(max * 0.50), 1),
            to: Math.max(Math.floor(max * 0.75), 1),
            color: "#b5ff33",

        }, {
            from: Math.max(Math.ceil(max * 0.75), 1),
            to: Math.max(max, Math.floor(max * 0.75)),
            color: "#38e330",

        }, {
            from: max + 1,
            to: Number.POSITIVE_INFINITY,
            color: "#67b92e",
            name: "+" + (max + 1)
        }

        ];
        myApexChart.updateOptions(heatmapOptions);

    }

  
    //Funcion que muestra u oculta la leyenda del gráfico
    function hideLegend() {
        legendActive = javaConnector.swapLegend();
        imageButton("btnLegend", legendActive);
    }

    function showGeneralMean() {
        mean = javaConnector.swapMean();
        imageButton("btnMean", mean);
        javaConnector.updateChartFromJS();
    }

    function showGroupMean() {
        mean = javaConnector.swapGroupMean();
        imageButton("btnGroupMean", mean);
        javaConnector.updateChartFromJS();
    }

    function hideLegendChartjs() {
        hideLegend();
        Chart.defaults.global.legend.display = legendActive;
        myChart.options.legend.display = legendActive;
        myChart.update();
    }


    function hideLegendApexCharts(option) {
        hideLegend();
        option.legend.show = legendActive;
        myApexChart.updateOptions(option);
    }


    function exportChartjs() {
        return myChart.toBase64Image();
    }

    function exportApexcharts() {

        myApexChart.dataURI().then(function (uri) {
            javaConnector.saveImage(uri);
        }).catch(function (error) {
            javaConnector.showErrorWindow("Cannot download image:" + error.message);
        })

    }
    function genericExport(id) {
        html2canvas(document.getElementById(id), { logging: false }).then(function (canvas) {
            javaConnector.saveImage(canvas.toDataURL());
        }).catch(function (error) {
            javaConnector.showErrorWindow("Cannot download image:" + error.message);
        })

    }

    // Modifica el valor de los inputs segun el idioma pasado
    function getI18n(item) {
        document.getElementById(item).value = javaConnector.getI18n("html." + item);
    }

    // Establece el idioma
    function setLanguage() {
        let tabs = document.querySelectorAll("#all_tabs > div > input");
        for (i = 0; i < tabs.length; i++) {
            getI18n(tabs[i].id);
        }
    }




    function colorRGB(color) {
        let colors = colorHash.rgb(color);
        return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
    }

    function colorRGBA(color, alpha) {
        let colors = colorHash.rgb(color);
        return "rgba(" + colors[0] + "," + colors[1] + "," + colors[2] + "," + alpha + ")";
    }
    //Funcion que devuelve un color en formato hexadecimal
    //en base a el string que se le pasa
    function colorHEX(color) {
        return colorHash.hex(color);
    }

    // Plugin que nos permite establecer el color de fondo del gráfico
    // el color se define en opciones->chartArea->backgroundColor
    Chart.pluginService.register({
        beforeDraw: function (chart, easing) {
            if (chart.config.options.chartArea && chart.config.options.chartArea.backgroundColor) {
                var helpers = Chart.helpers;
                var ctx = chart.chart.ctx;
                var canvas = document.getElementById('myChart');

                ctx.save();
                ctx.fillStyle = chart.config.options.chartArea.backgroundColor;
                ctx.fillRect(0, 0, canvas.scrollWidth, canvas.scrollHeight);
                ctx.restore();
            }
        }
    });
</script>

</body>

</html>