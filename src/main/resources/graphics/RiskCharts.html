<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <title>Charts</title>
    <link rel="stylesheet" type="text/css" href="../css/tabulator.css" />
    <link rel="stylesheet" type="text/css" href="../css/chart.css" />

    <script type="text/javascript" src="./lib/moment-with-locale.js"></script>
    <script type="text/javascript" src="./lib/Chart.js"></script>
    <script type="text/javascript" src="./lib/color-hash.js"></script>
    <script type="text/javascript" src="./lib/html2canvas.js"></script>
    <script type="text/javascript" src="./lib/apexcharts.js"></script>
    <script type="text/javascript" src="./lib/chartjs-chart-box-and-violin-plot.js"></script>
    <script type="text/javascript" src="./lib/chartjs-plugin-datalabels.js"></script>
    <script type="text/javascript" src="./lib/tabulator.js"></script>


</head>

<div id="all_tabs" class="controles">
    <div class="pestañas" id="RISK">
 
     
       
    </div>

    <div class="opciones">
        <button value="Leyenda" class="btn" id="btnLegend" onclick="hideLegend()" />
        <button value="Media General" class="btn" id="btnMean" onclick="showGeneralMean()" />
        <button class="btn" id="btnGroupMean" onclick="showGroupMean()" />
    </div>
</div>

<div id="chart-container" class="chart-container">
    <canvas id="myChart"></canvas>
</div>
<div id="apexchartsDiv"></div>
<div id="tabulatorDiv"></div>

<script type="text/javascript">
    //------------------------------------------Opciones para los graficos------------------------------------------------------------------

    Chart.defaults.global.animation.duration = 0;
    Chart.defaults.global.elements.line.fill = false;
    Chart.defaults.global.elements.line.tension = 0;
    Chart.defaults.global.maintainAspectRatio = false;
    Chart.defaults.global.hover.animationDuration = 0;
    Chart.defaults.global.legend.labels.usePointStyle = true;
    Chart.defaults.global.legend.position = "top";
	Chart.defaults.global.plugins.datalabels.display = false
    Chart.defaults.scale.ticks.beginAtZero = true;
    Chart.defaults.scale.ticks.precision = 0;
    Chart.defaults.scale.autoSkip = true;
	Chart.plugins.register({
	  beforeDraw: function(chartInstance) {
	    var ctx = chartInstance.chart.ctx;
	    ctx.fillStyle = chartInstance.config.options.chartBackgroundColor;
	    ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
	  }
	});
    

    var counter = 0;
    var height = "93%";
    var locale = 'en-UK';


    //------------------------------------------Variables globales-------------------------------------------------------------

    //
    var colorHash = new ColorHash();
    var ctx = document.getElementById('myChart');

    var myChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: []
        },
        options: {
            tab: "grade_tabs",
            button: "btnLine",
            typeGraph: "line"
        }
    });

    var myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), { tab: "log_tabs", button: "btnHeatmap", typeGraph: "heatmap", tooltip: { x: { show: !0 } }, plotOptions: { heatmap: { enableShades: !1, colorScale: { ranges: [{ from: -1, to: 0, color: "#f78880", name: "0" }, { from: 1, to: 1, color: "#f4e3ae" }, { from: 1, to: 1, color: "#fff033" }, { from: 1, to: 1, color: "#b5ff33" }, { from: 1, to: 1, color: "#38e330" }, { from: 2, to: Number.POSITIVE_INFINITY, color: "#67b92e", name: "+2" }] } } }, legend: { position: "top" }, chart: { type: "heatmap", events: { dataPointSelection: function (o, e, t) { javaConnector.dataPointSelection(t.w.config.series.length - 1 - t.seriesIndex) } }, height: height, toolbar: { show: !1 }, animations: { enabled: !1 } }, dataLabels: { formatter: function (o, e) { return 0 == o ? "" : o }, style: { colors: ["#000000"] } }, colors: ["#00A100"], series: [], xaxis: { categories: [] } });
    myApexChart.render();

    var table = new Tabulator("#tabulatorDiv", {

        tab: "activity_tabs",
        button: "ACTIVITIES_TABLE",
        invalidOptionWarnings: false,
        height: height,
        //placeholder: "No data",
        tooltipsHeader: true,
        virtualDom: true,
        layout: "fitColumns", //fit columns to width of table (optional)
        rowClick: function (e, row) {
            javaConnector.dataPointSelection(row.getPosition());

        },
    });


    //------------------------------------------Funciones------------------------------------------------------------------


    function imageButton(id, value) {
        if (value) {
            document.getElementById(id).style.backgroundImage = 'url(./../img/visibility.png)';

        } else {
            document.getElementById(id).style.backgroundImage = 'url(./../img/visibility_off.png)';
        }
    }

    function displayLegendButton(value) {
        document.getElementById('btnLegend').style.display = value ? "inline" : "none";
    }

    function displayGroupButton(value) {
        document.getElementById('btnGroupMean').style.display = value ? "inline" : "none";
    }

    function displayGeneralButton(value) {
        document.getElementById('btnMean').style.display = value ? "inline" : "none";
    }

    function displayApexChart(value) {
        document.getElementById('apexchartsDiv').style.display = value ? "block" : "none";
    }
    function displayTabulator(value) {
        document.getElementById('tabulatorDiv').style.display = value ? "block" : "none";
    }


    function displayChartjs(value) {
        document.getElementById('chart-container').style.display = value ? "block" : "none";
    }



    function displayChartsButtons(div_id, type) {
        let tabs = document.getElementById(div_id);
        let children = tabs.children;
        for (i = 0; i < children.length; i++) {
            if (children[i].tagName == "BUTTON") {
                children[i].style.display = div_id == type ? "inline" : "none";
            }

        }
    }

    function disableTab(div_id, no_disable) {
        if (document.getElementById(no_disable).disabled == false) {
            let tabs = document.getElementById(div_id);
            let children = tabs.children;
            for (i = 0; i < children.length; i++) {
                if (children[i].tagName == "BUTTON") {
                    children[i].disabled = false;
                }

            }
            document.getElementById(no_disable).disabled = true;
        }


    }


    function updateApexCharts(series, categories, options) {
        displayApexChart(true);
        displayChartjs(false);
        displayTabulator(false);


        disableTab(options.tab, options.button);

        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);

        options.series = series;
        options.xaxis.categories = categories;
        options.legend.show = options.useLegend && options.legendActive;
        if (myApexChart.w.config.chart.type == options.typeGraph) {

            myApexChart.updateOptions(options);
        } else {

            myApexChart.destroy();
            myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), options);
            myApexChart.render();
        }
    }

    function updateChartjs(dataset, options) {
    	
        displayApexChart(false);
        displayChartjs(true);
        displayTabulator(false);
        imageButton("btnLegend", options.legendActive);
        imageButton("btnMean", options.generalActive);
        imageButton("btnGroupMean", options.groupActive);


        disableTab(options.tab, options.button);

        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);
		if(!options.legend){
			options.legend={};
		}
		options.legend.display = options.legendActive;
        if (myChart.config.type == options.typeGraph) {
            myChart.data = dataset;
            myChart.options = options;
            myChart.update();        
            
            
        } else {
            myChart.destroy();
            myChart = new Chart(ctx, {
                type: options.typeGraph,
                data: dataset,
                options: options
            });
        }

    }

    function updateTabulator(columns, tabledata, options) {

        displayApexChart(false);
        displayChartjs(false);
        displayTabulator(true);
        disableTab(options.tab, options.button);
        displayLegendButton(options.useLegend);
        displayGroupButton(options.useGroup);
        displayGeneralButton(options.useGeneral);
        disableTab(options.tab, options.button);
        table.destroy()
        table = new Tabulator("#tabulatorDiv", options);
        table.setColumns(columns);
        table.setData(tabledata).then(function () {
            table.redraw();
        })


    }



    function clearChartjs() {
        myChart.destroy();
        myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: []
            },
            options: {
                type: "line",
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    tab: "grade_tabs",
                    button: "btnLine",
                    typeGraph: "line"
                }
            }
        });
    }


    function manageButtons(type) {

		displayChartsButtons("RISK", type);
        //displayChartsButtons("GRADES", type);
        //displayChartsButtons("LOGS", type);
        //displayChartsButtons("ACTIVITY_COMPLETION", type);

    }

    //Funcion que muestra u oculta la leyenda del gráfico
    function hideLegend() {
        imageButton("btnLegend", javaConnector.swapLegend());
        
        javaConnector.updateChart();
    }

    function showGeneralMean() {
   
        imageButton("btnMean",  javaConnector.swapGeneral());
       
        javaConnector.updateChart();
    }

    function showGroupMean() {
     
        imageButton("btnGroupMean",javaConnector.swapGroup());
        
        javaConnector.updateChart();
    }


    function exportChartjs() {
        return myChart.toBase64Image();
    }

    function exportApexcharts() {

        myApexChart.dataURI().then(function (uri) {
            javaConnector.saveImage(uri);
        }).catch(function (error) {
            javaConnector.showErrorWindow("Cannot download image:" + error.message);
        })

    }
    function genericExport(id) {
        html2canvas(document.getElementById(id), { logging: false }).then(function (canvas) {
            javaConnector.saveImage(canvas.toDataURL());
        }).catch(function (error) {
            javaConnector.showErrorWindow("Cannot download image:" + error.message);
        })

    }

 function generateButtons(buttons){
    	for (const value of buttons){
			let button = document.createElement("BUTTON");
			button.id = value.id;
			button.innerText = value.text;
			button.className = "btn";
			//button.type = "button";
			button.setAttribute( "onClick", "javascript: javaConnector.updateCharts(this.id);" );
			
			type = document.getElementById(value.type);
			type.appendChild(button);
    	}
    }


 function translate(id, text){
    	document.getElementById(id).innerText = text;
    }

    function setLocale(newLocale) {
        locale = newLocale;
        moment.locale(newLocale);
    }
    function colorRGB(color) {
        let colors = colorHash.rgb(color);
        return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
    }

    function colorRGBA(color, alpha) {
        let colors = colorHash.rgb(color);
        return "rgba(" + colors[0] + "," + colors[1] + "," + colors[2] + "," + alpha + ")";
    }
    //Funcion que devuelve un color en formato hexadecimal
    //en base a el string que se le pasa
    function colorHEX(color) {
        return colorHash.hex(color);
    }

</script>


</html>