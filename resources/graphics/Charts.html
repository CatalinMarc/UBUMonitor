<html>
<meta charset="UTF-8">
<head>
<link rel="stylesheet" type="text/css" href="../css/chart.css" />


<script type="text/javascript" src="./lib/Chart.js"></script>
<script type="text/javascript" src="./lib/color-hash.js"></script>
<script type="text/javascript" src="./lib/googleCharts.js"></script>
<script type="text/javascript" src="./lib/html2canvas.js"></script>
<script type="text/javascript" src="./messages.js"></script>

</head>

<body>

	<div class="controles">
		<div class="pestañas">
			<input type="button" value="Lineas" class="btn" id="btnLineas"
				onclick="generateChart('line')" /> <input type="button"
				value="Radar" class="btn" id="btnRadar"
				onclick="generateChart('radar')" /> <input type="button"
				value="BoxPlot General" class="btn" id="btnBoxPlot"
				onclick="generateChart('boxplot')" /> <input type="button"
				value="BoxPlot Del Grupo" class="btn" id="btnBoxPlotGroup"
				onclick="generateChart('boxplotgroup')" /> <input type="button"
				value="Barras Apiladas" class="btn" id="btnStackedBar"
				onclick="generateChart('stackedBar')" /> <input type="button"
				value="Calificaciones" class="btn" id="btnCalificaciones"
				onclick="drawTable()" />

		</div>

		<div class="opciones">
			<input type="button" value="." class="btn"
				style="visibility: hidden; width: 0px; margin: 0px; padding: 0px;" />
			<input type="button" value="Leyenda" class="btn" id="btnLegend"
				onclick="hideLegend()" /> <input type="button" value="Media General"
				class="btn" id="btnMean" onclick="showGeneralMean()" /> <input
				type="button" value="Media Del Grupo" class="btn" id="btnGroupMean"
				onclick="showGroupMean()" />
		</div>
	</div>

	<div id="inicio" class="inicio">
		<img class="imginicio" src="../img/logo.png">
	</div>

	<div id="noradar" class="card">
		<div id="noradarText" class="cardText">Selecciona al menos 3
			actividades para mostrar el gráfico</div>
	</div>

	<div id="noGroup" class="card">
		<div id="noGroupText" class="cardText">Selecciona un grupo para
			mostrar el gráfico</div>
	</div>

	<div id="chart-container" class="chart-container">
		<canvas id="myChart"></canvas>
	</div>

	<div id="table_div" class="table_div"></div>

	<div id="table_img" style="display: none;"></div>

	<script type="text/javascript">
//------------------------------------------Opciones para los graficos------------------------------------------------------------------
// Opciones para el gráfico de lineas y el boxplot
var optionsLineChart = {
	maintainAspectRatio: false,
	responsive: true,
	responsiveAnimationDuration: 0, // animation duration after a resize, better perfomance at 0
	showLines: true,
	spanGaps: false, //si se quiere mostrar las lineas cuando en algun elemento no hay dato (NaN)
	animation:{
		 duration: 0 // better performance at 0
	}, //animation
	layout: {
		padding: {
			top: 20,
		} //pading
	}, //layout
	elements: {
		point : {
			pointStyle: 'circle',
			radius: 5,
			hoverRadius: 7
		}, //points
		line: {
			tension: 0 //at 0 disable bezier curves, better performance
		}
	}, //elements
	legend: {
		display: true,
		position: 'bottom',
		labels : {
			padding: 20,
			usePointStyle: true,
			fontSize: 12,
			fontColor: 'rgba(0, 0, 0, 1)',
			fontFamily: 'sans-serif'
		} //labels
	}, //legend
	tooltips: {
		mode: 'index',
		intersect: false,
		position: 'average',
		backgroundColor: 'rgba(0, 0, 0, 1)',
		bodySpacing: 4,
		cornerRadius: 0,
		caretSize: 10,
		itemSort: function(a, b) {return (parseFloat(a.y) - parseFloat(b.y));}	
	}, //tooltips
    scales: {
        yAxes: [
        	{
        		id:'left-y-axis',
        		type: 'linear',
        		position: 'left',
        		gridLines: {
            		display: true,
            		color: 'rgba(0, 0, 0, 0.4)'
            	}, //gridLines
                ticks: 
                {
                    beginAtZero:true,
                    suggestedMax: 10,
                    stepSize: 1,
                    fontColor: 'rgba(0, 0, 0, 1)'
                }//ticks
        	},
        	{
        		id: 'right-y-axis',
        		type: 'linear',
        		position: 'right',
        		gridLines: {
            		display: true,
            		color: 'rgba(0, 0, 0, 0.4)'
            	}, //gridLines
                ticks: 
                {
                    beginAtZero:true,
                    suggestedMax: 10,
                    stepSize: 1,
                    fontColor: 'rgba(0, 0, 0, 1)'
                }//ticks
        	}], //yAxes
        xAxes :[{
        	gridLines: {
        		display: true,
        		color: 'rgba(0, 0, 0, 0.4)'
        	}, //gridLines
        	ticks: {
        		autoSkip: false,
        		fontColor: 'rgba(0, 0, 0, 1)'
        	}
        }]//xAxes
    }, //scales
    chartArea: {
    	backgroundColor: 'rgba(255,255,255,1)'
    } //chartArea
} //options
	
// Opciones para el radar
var optionsRadarChart = {
	maintainAspectRatio: false,
	responsive: true,
	responsiveAnimationDuration: 0, // animation duration after a resize, better perfomance at 0
	showLines: true,
	spanGaps: false, //si se quiere mostrar las lineas cuando en algun elemento no hay dato (NaN)
	animation:{
		 duration: 0 // better performance at 0
	}, //animation
	layout: {
		padding: {
			top: 20,
		} //pading
	}, //layout
	elements: {
		point : {
			pointStyle: 'circle',
			radius: 5,
			hoverRadius: 7
		}, //points
		line: {
			tension: 0 //disable bezier curves, better performance
		}
	}, //elements
	legend: {
		display: true,
		position: 'bottom',
		labels : {
			padding: 20,
			usePointStyle: true,
			fontSize: 12,
			fontColor: 'rgba(0, 0, 0, 1)',
			fontFamily: 'sans-serif'
		} //labels
	}, //legend
	tooltips: {
		mode: 'index',
		intersect: true,
		position: 'average',
		backgroundColor: 'rgba(0, 0, 0, 1)',
		bodySpacing: 4,
		cornerRadius: 0,
		caretSize: 10,
		itemSort: function(a, b) {return (parseFloat(a.y) - parseFloat(b.y));}	
	}, //tooltips
    scale: {
		gridLines: {
    		display: true,
    		color: 'rgba(0, 0, 0, 0.4)'
    	}, //gridLines
        ticks: 
        {
            beginAtZero:true,
            suggestedMax: 10,
            stepSize: 1,
            fontColor: 'rgba(0, 0, 0, 1)'
        }//ticks
    }, //scales
    chartArea: {
    	backgroundColor: 'rgba(255,255,255,1)'
    } //chartArea
} //options


var optionsStackedBar= {
	maintainAspectRatio: false,
	responsive: true,
	animation: {
        duration: 0, // general animation time
    },
	elements: {
		line: {
			tension: 0 //at 0 disable bezier curves, better performance
		}
	}, //elements
	tooltips: {
		position: 'nearest',
		mode: 'x',
		callbacks: {
			label: function(tooltipItem, data) {
				return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel*100)/100;
			},
			afterTitle: function(tooltipItem, data) {
				//Despues del titulo ponemos el nombre y apellidos del usuario
				return data.datasets[tooltipItem[0].datasetIndex].stack;
			}
		}
	},
	scales:{
        yAxes: [{
        	stacked:true,
            gridLines: {
                display:false
            },
            ticks: {
                beginAtZero:true,
                min:0,
            }
        }]
    },
	legend: {
		display: true,
		position: 'bottom',
		labels: {
			padding: 20,
			usePointStyle: true,
			fontSize: 12,
			fontColor: 'rgba(0, 0, 0, 1)',
			fontFamily: 'sans-serif',
			filter: function(legendItem, chartData) {
				//mostramos en la leyenda los que son lineas
				return chartData.datasets[legendItem.datasetIndex].type == "line";
			}//filter
		}//labels
	} //legend

}

//------------------------------------------Variables globales-------------------------------------------------------------
// DataSets
var GeneralMeanDataSet = '';
var GroupMeanDataSet = '';
var LineDataSet = '';
var RadarDataSet = '';
var BoxPlotGeneralDataSet = '';
var BoxPlotGroupDataSet = '';
var TableDataSet = '';
var StackedBarDataSet= '';
//
var GeneralMeanActive = false;
var GroupMeanActive = false;
var legendActive = true;
var currentType = 'line';
var currentGradeType='line';
var currentLogType='stackedBar';


var language = 'es';


//
var colorHash = new ColorHash();
var ctx = document.getElementById('myChart');
var myChart = new Chart(ctx,{
	type: 'line',
	data:LineDataSet,
	options: optionsLineChart
});
// Cargamos la librearia de google para la tabla de calificaciones
google.charts.load('current', {'packages':['table']});
var table;
// Al iniciar el boton del gráfico de lineas esta deshabilitado
document.getElementById('btnLineas').disabled = true;
document.getElementById('btnStackedBar').disabled = true;

//Al iniciar el div de la tabla de calificaciones esta oculto
document.getElementById('table_div').style.display = 'none';
//ocultamos los de logs
document.getElementById('btnStackedBar').style.display = "none";


document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';


//------------------------------------------Funciones------------------------------------------------------------------
// Funcion que crea la tabla de calificaciones
function drawTable() {
	
	  var cssClassNames = {
			    headerRow: 'actividades',
			    tableRow: 'filasTabla',
			    oddTableRow: 'filasImpares',
			    selectedTableRow: 'filaSeleccionada',
			    hoverTableRow: 'filaHover',
			    headerCell: 'actividadesCelda',
			    tableCell: 'tablaCelda'};
	
	currentType = 'table';
	if(GeneralMeanActive){showGeneralMean();}
	if(GroupMeanActive){showGroupMean();}
	document.getElementById('btnLineas').disabled = false;
	document.getElementById('btnRadar').disabled = false;
	document.getElementById('btnBoxPlot').disabled = false;
	document.getElementById('btnBoxPlotGroup').disabled = false;
	document.getElementById('btnCalificaciones').disabled = true;
	document.getElementById('inicio').style.display = 'none';
	document.getElementById('noradar').style.display = 'none';
	document.getElementById('noGroup').style.display = 'none';
	document.getElementById('chart-container').style.display = 'none';
	document.getElementById('table_div').style.display = 'block';
	document.getElementById('btnMean').style.display = 'none';
	document.getElementById('btnGroupMean').style.display = 'none';
	document.getElementById('btnLegend').style.display = 'none';
	var data = google.visualization.arrayToDataTable(TableDataSet, false); // 'false' indica que la primera fila son labels, no datos.
	table = new google.visualization.Table(document.getElementById('table_div'));
    table.draw(data, {showRowNumber: false, allowHTML: true, width: '100%', cssClassNames: cssClassNames, frozenColumns: 1});
    
    // Al generar la tabla generamos la imagen para la exportación
	html2canvas(document.getElementById('table_div'), {
		onrendered: function(canvas) {
			elem = document.querySelector('#table_img canvas');
			if(elem != null) {
				elem.parentNode.removeChild(elem);
			}
			document.getElementById('table_img').appendChild(canvas);
		}	
	});
 }
// Funcion que genera y muestra el grafico segun el tipo que se le pase.
function generateChart(type){
	document.getElementById('table_div').style.display = 'none';
	document.getElementById('chart-container').style.display = 'block';
	document.getElementById('inicio').style.display = 'none';
	document.getElementById('noradar').style.display = 'none';
	document.getElementById('noGroup').style.display = 'none';
	document.getElementById('btnLegend').style.display = 'inline';
	
	document.getElementById('btnLineas').disabled = false;
	document.getElementById('btnRadar').disabled = false;
	document.getElementById('btnBoxPlot').disabled = false;
	document.getElementById('btnBoxPlotGroup').disabled = false;
	document.getElementById('btnCalificaciones').disabled = false;

	
	currentType = type;

	switch (type) {
		case 'line':
			document.getElementById('btnLineas').disabled = true;

			document.getElementById('btnMean').style.display = 'inline';
			document.getElementById('btnGroupMean').style.display = 'inline';
			if(GeneralMeanActive){showGeneralMean();}
			if(GroupMeanActive){showGroupMean();}
			myChart.destroy();
			myChart = new Chart(ctx,{
				type: 'line',
				data: LineDataSet,
				options: optionsLineChart
			});
			myChart.data.datasets.forEach((dataset) => {
				color = colorRGB(dataset.label);
				dataset.backgroundColor = color + '1)';
				dataset.borderColor = color + '1)';
				dataset.pointBackgroundColor = color + '1)';
				dataset.pointBorderColor = color + '1)';
				dataset.fill = false;
			});
			break;
		case 'boxplot':
		
			document.getElementById('btnBoxPlot').disabled = true;

			document.getElementById('btnMean').style.display = 'none';
			document.getElementById('btnGroupMean').style.display = 'none';
			if(GeneralMeanActive){showGeneralMean();}
			if(GroupMeanActive){showGroupMean();}
			myChart.destroy();
			myChart = new Chart(ctx,{
				type: 'line',
				data: BoxPlotGeneralDataSet,
				options: optionsLineChart
			});
			break;
		case 'boxplotgroup':
			document.getElementById('btnBoxPlotGroup').disabled = true;
			document.getElementById('btnMean').style.display = 'none';
			document.getElementById('btnGroupMean').style.display = 'none';
			if(GeneralMeanActive){showGeneralMean();}
			if(GroupMeanActive){showGroupMean();}
			myChart.destroy();
			myChart = new Chart(ctx,{
				type: 'line',
				data: BoxPlotGroupDataSet,
				options: optionsLineChart
			});
			if(BoxPlotGroupDataSet == '') {
				document.getElementById('chart-container').style.display = 'none';
				document.getElementById('noGroup').style.display = 'block';
			}
			break;
		case 'radar':
			document.getElementById('btnRadar').disabled = true;
			document.getElementById('btnMean').style.display = 'inline';
			document.getElementById('btnGroupMean').style.display = 'inline';
			if(GeneralMeanActive){showGeneralMean();}
			if(GroupMeanActive){showGroupMean();}
			myChart.destroy();
			myChart = new Chart(ctx,{
				type: 'radar',
				data: RadarDataSet,
				options: optionsRadarChart
			});
			myChart.data.datasets.forEach((dataset) => {
				color = colorRGB(dataset.label);
				dataset.backgroundColor = color + '0.3)';
				dataset.borderColor = color + '1)';
				dataset.pointBackgroundColor = color + '1)';
				dataset.pointBorderColor = color + '1)';
				dataset.fill = true;
			});
			if(myChart.data.labels.length < 3) {
				document.getElementById('chart-container').style.display = 'none';
				document.getElementById('noradar').style.display = 'block';
			}
			break;
		case 'stackedBar':
			document.getElementById('btnStackedBar').disabled = true;
			document.getElementById('btnMean').style.display = 'none';
			document.getElementById('btnGroupMean').style.display = 'none';
			myChart.destroy();
			myChart = new Chart(ctx,{
				type: 'bar',
				data: StackedBarDataSet,
				options: optionsStackedBar
			});
			break;
			
			
				
	}
	myChart.update();
}
// Funcion que recibe el tipo de grafico y su data set y lo actualiza
function updateChart(type, dataSet){
	if(currentType != 'table') {
		document.getElementById('chart-container').style.display = 'block';
		document.getElementById('inicio').style.display = 'none';
		switch (type) {
			case 'line':
				LineDataSet = dataSet;
				if(currentType == 'line'){				
					myChart.data = LineDataSet;
					myChart.data.datasets.forEach((dataset) => {
						color = colorRGB(dataset.label);
						dataset.backgroundColor = color + '1)';
						dataset.borderColor = color + '1)';
						dataset.pointBackgroundColor = color + '1)';
						dataset.pointBorderColor = color + '1)';
						dataset.fill = false;
					});
					if (GeneralMeanActive) {myChart.data.datasets.push(GeneralMeanDataSet);}
					if (GroupMeanActive) {myChart.data.datasets.push(GroupMeanDataSet);}
				}
				break;
			case 'boxplot':
				BoxPlotGeneralDataSet = dataSet;
				if(currentType == 'boxplot'){
					myChart.data = BoxPlotGeneralDataSet;	
				}
				break;
			case 'boxplotgroup':
				BoxPlotGroupDataSet = dataSet;
				if(currentType == 'boxplotgroup'){
					myChart.data = BoxPlotGroupDataSet;	
				}
				if(BoxPlotGroupDataSet == '') {
					document.getElementById('chart-container').style.display = 'none';
					document.getElementById('noGroup').style.display = 'block';
				} else {
					document.getElementById('noGroup').style.display = 'none';
				}
				break;
			case 'radar':
				RadarDataSet = dataSet;
				if(currentType == 'radar'){
					myChart.data = RadarDataSet;
					myChart.data.datasets.forEach((dataset) => {
						color = colorRGB(dataset.label);
						dataset.backgroundColor = color + '0.3)';
						dataset.borderColor = color + '1)';
						dataset.pointBackgroundColor = color + '1)';
						dataset.pointBorderColor = color + '1)';
						dataset.fill = true;
					});
					if (GeneralMeanActive) {myChart.data.datasets.push(GeneralMeanDataSet);}
					if (GroupMeanActive) {myChart.data.datasets.push(GroupMeanDataSet);}
					if(myChart.data.labels.length < 3) {
						document.getElementById('chart-container').style.display = 'none';
						document.getElementById('noradar').style.display = 'block';
					} else {
						document.getElementById('noradar').style.display = 'none';
					}
				}
				break;
			case 'stackedBar':
				StackedBarDataSet=dataSet;
				if(currentType == 'stackedBar'){
		
					myChart.data=StackedBarDataSet;
				}

		}
		myChart.update();
	}
}



function manageGradesButtons(){
	
	
	//ocultamos los botones de las graficas 
	document.getElementById('btnLineas').style.display = "inline";
	document.getElementById('btnRadar').style.display = "inline";
	document.getElementById('btnBoxPlot').style.display = "inline";
	document.getElementById('btnBoxPlotGroup').style.display = "inline";
	document.getElementById('btnCalificaciones').style.display = "inline";
	
	//ocultamos los de logs
	document.getElementById('btnStackedBar').style.display = "none";
	
	currentLogType=currentType;
	
	generateChart(currentGradeType);
}


function manageLogsButtons(){
	
	
	//ocultamos los botones de las graficas que no sean de log
	document.getElementById('btnLineas').style.display = "none";
	document.getElementById('btnRadar').style.display = "none";
	document.getElementById('btnBoxPlot').style.display = "none";
	document.getElementById('btnBoxPlotGroup').style.display = "none";
	document.getElementById('btnCalificaciones').style.display = "none";
	
	//mostramos los de logs
	document.getElementById('btnStackedBar').style.display = "inline";
	
	currentGradeType=currentType;
	
	generateChart(currentLogType);
	

}

function changeYMaxStackedBar(max){
	optionsStackedBar.scales.yAxes[0].ticks.suggestedMax=max;
	myChart.options=optionsStackedBar;
	myChart.update();
}

//Funcion que almacena la media general.
function saveMean(mean) {
	GeneralMeanDataSet = mean;
}
//Funcion que almacena la media del grupo.
function saveGroupMean(mean){
	GroupMeanDataSet = mean;
}
//Funcion que almacena la media del grupo.
function saveTableData(dataSet){
	TableDataSet = dataSet;
	if(currentType == 'table'){
		drawTable();
	}
}
//Funcion que muestra u oculta la media general del gráfico
function showGeneralMean() {
	if('' != GeneralMeanDataSet && GeneralMeanActive == false){
		GeneralMeanActive = true;
		myChart.data.datasets.push(GeneralMeanDataSet);
		myChart.update();
		document.getElementById('btnMean').style.backgroundImage = 'url(./../img/visibility.png)';
	} else if(GeneralMeanActive == true){
		GeneralMeanActive = false;
		removeDataSet(messages['btnMean'][language]);
		document.getElementById('btnMean').style.backgroundImage = 'url(./../img/visibility_off.png)';
	}
}
//Funcion que muestra u oculta la media del grupo del gráfico
function showGroupMean() {
	if('' != GroupMeanDataSet && GroupMeanActive == false){
		GroupMeanActive = true;
		myChart.data.datasets.push(GroupMeanDataSet);
		myChart.update();
		document.getElementById('btnGroupMean').style.backgroundImage = 'url(./../img/visibility.png)';
	} else if(GroupMeanActive == true){
		GroupMeanActive = false;
		removeDataSet(messages['btnGroupMean'][language]);
		document.getElementById('btnGroupMean').style.backgroundImage = 'url(./../img/visibility_off.png)';
	}
}
//Elimina el DataSet del gráfico que conincida con la label pasada
function removeDataSet(DataSetLabel) {
	var arrayLength = myChart.data.datasets.length;
	
	for(var i = 0; i < arrayLength; i++) {
		if(myChart.data.datasets[i].label == DataSetLabel){
			myChart.data.datasets.splice(i,1);
			myChart.update();
			i = arrayLength;
		}
	}
}
//Funcion que muestra u oculta la leyenda del gráfico
function hideLegend(){
	if(legendActive == true){
		legendActive = false;
		myChart.options.legend.display = false;
		myChart.update();
		document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility_off.png)';
	} else {
		legendActive = true;
		myChart.options.legend.display = true;
		myChart.update();
		document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';
	}
}
//Funcion que devuelve un color en formato 'rgba(r,g,b', a falta de la transpaerncia
//en base a el string que se le pasa
function colorRGB(color){
	var rgbaColor = 'rgba(';
	var colors = []
	colors = colorHash.rgb(color);
	for (i = 0; i < colors.length; i++) {
		rgbaColor += colors[i] + ',';
	}
	return rgbaColor;
}
//Funcion que devuelve un color en formato hexadecimal
//en base a el string que se le pasa
function colorHEX(color){
	return colorHash.hex(color);
}
// Exporta el elemento actual
function exportCurrentElemet() {
	if(currentType == 'table') {
		return document.querySelector('#table_img canvas').toDataURL();
	} else {
		myChart.update(); // por algun motivo si no se actualiza no cambia la grafica elegida
		return myChart.toBase64Image();
	}
}



// Plugin que nos permite establecer el color de fondo del gráfico
// el color se define en opciones->chartArea->backgroundColor
Chart.pluginService.register({
	beforeDraw: function (chart, easing) {
		if (chart.config.options.chartArea && chart.config.options.chartArea.backgroundColor) {
			var helpers = Chart.helpers;
			var ctx = chart.chart.ctx;
			var canvas = document.getElementById('myChart');
			
			ctx.save();
			ctx.fillStyle = chart.config.options.chartArea.backgroundColor;
			ctx.fillRect(0, 0, canvas.scrollWidth, canvas.scrollHeight);
			ctx.restore();
		}
	}
});

</script>

</body>
</html>