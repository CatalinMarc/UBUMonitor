<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <title>Charts</title>
    <link rel="stylesheet" type="text/css" href="../css/chart.css" />

    <script type="text/javascript" src="./lib/Chart.js"></script>
    <script type="text/javascript" src="./lib/color-hash.js"></script>
    <script type="text/javascript" src="./lib/html2canvas.js"></script>
    <script type="text/javascript" src="./messages.js"></script>
    <script type="text/javascript" src="./lib/apexcharts.js"></script>
</head>

<div class="controles">
    <div class="pestañas" id="grade_tabs">
        <input type="button" class="btn" id="btnLine" onclick='javaConnector.updateCharts("LINE");' />
        <input type="button" class="btn" id="btnRadar" onclick='javaConnector.updateCharts("RADAR");' />
        <input type="button" class="btn" id="btnBoxPlot" onclick='javaConnector.updateCharts("GENERAL_BOXPLOT");' />
        <input type="button" class="btn" id="btnBoxPlotGroup" onclick='javaConnector.updateCharts("GROUP_BOXPLOT");' />
        <input type="button" class="btn" id="btnCalificaciones" onclick='javaConnector.updateCharts("TABLE");' />
    </div>
    <div class="pestañas" id="log_tabs">
        <input type="button" class="btn" id="btnStackedBar" onclick='javaConnector.updateCharts("STACKED_BAR");' />
        <input type="button" class="btn" id="btnHeatmap" onclick='javaConnector.updateCharts("HEAT_MAP");' />
    </div>

    <div class="opciones">
        <input type="button" value="." class="btn" style="visibility: hidden; width: 0px; margin: 0px; padding: 0px;" />
        <input type="button" value="Leyenda" class="btn" id="btnLegend" onclick="javaConnector.hideLegend();" />
        <input type="button" value="Media General" class="btn" id="btnMean" onclick="showGeneralMean()" />
        <input type="button" class="btn" id="btnGroupMean" onclick="showGroupMean()" />
    </div>
</div>

<div id="chart-container" class="chart-container">
    <canvas id="myChart"></canvas>
</div>
<div id="apexchartsDiv"></div>

<script type="text/javascript">
    //------------------------------------------Opciones para los graficos------------------------------------------------------------------
    Chart.defaults.global.animation.duration = 0;
    Chart.defaults.global.elements.line.fill = false;
    Chart.defaults.global.maintainAspectRatio = false;
    Chart.defaults.global.hover.animationDuration = 0;
    Chart.defaults.global.legend.labels.usePointStyle = true;
    Chart.defaults.global.legend.position = "bottom";
    Chart.defaults.global.onClick = function (event, array) {
        let element = myChart.getElementAtEvent(event);
        if (element.length > 0) {

            javaConnector.dataPointSelection(element[0]._datasetIndex);
        }
    };

    var height = "93%";

    var stackedbarOptions = {
        tooltips: {
            position: 'nearest',
            mode: 'x',
            callbacks: {
                label: function (tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel *
                        100) / 100;
                },
                afterTitle: function (tooltipItem, data) {
                    //Despues del titulo ponemos el nombre y apellidos del usuario
                    return data.datasets[tooltipItem[0].datasetIndex].name;
                }
            }
        },
        scales: {
            yAxes: [{
                stacked: true,
                ticks: {
                    beginAtZero: true,
                    min: 0,
                }
            }]
        },
        legend: {
            labels: {
                filter: function (legendItem, chartData) {
                    //mostramos en la leyenda los que son lineas
                    return chartData.datasets[legendItem.datasetIndex].type == "line";
                } //filter
            } //labels
        } //legend

    }

    heatmapOptions = {
        tooltip: {
            x: {
                show: true
            }
        },
        plotOptions: {
            heatmap: {
                enableShades: false,
                //shadeIntensity: 0.5,
                colorScale: {
                    ranges: [{
                        from: -1,
                        to: 0,
                        color: "#f78880",
                        name: "0"
                    }, {
                        from: 1,
                        to: 1,
                        color: "#f4e3ae",
                    }, {
                        from: 1,
                        to: 1,
                        color: "#fff033",

                    },

                    {
                        from: 1,
                        to: 1,
                        color: "#b5ff33",

                    }, {
                        from: 1,
                        to: 1,
                        color: "#38e330",

                    }, {
                        from: 2,
                        to: Number.POSITIVE_INFINITY,
                        color: "#67b92e",
                        name: "+" + (2)
                    }

                    ]
                }
            }
        },
        legend: {
            position: 'bottom'
        },
        chart: {
            type: "heatmap",
            events: {
                dataPointSelection: function (event, chartContext, config) {
                    javaConnector.dataPointSelection(config.w.config.series.length - 1 - config.seriesIndex);
                }
            },
            height: height,
            toolbar: {
                show: false,
            },
            animations: {
                enabled: false
            }
        },
        dataLabels: {
            formatter: function (val, opts) {
                if (val == 0) {
                    return "";
                }
                return val;
            },
            style: {
                colors: ["#000000"]
            }
        },
        colors: ["#00A100"],
        series: [],
        xaxis: {
            categories: []
        }
    };




    var lineOptions = {
        scales: {
            yAxes: [{
                ticks: {
                    max: 10,
                    stepSize: 1,
                    beginAtZero: true,
                    min: 0,
                }
            }]
        }


    }

    var radarOptions = {
        scale: {
            ticks: {
                max: 10,
                stepSize: 1,
                beginAtZero: true,
                min: 0,
            }//ticks
        }, //scales

    } //options

    //------------------------------------------Variables globales-------------------------------------------------------------

    var language = 'es';

    //
    var colorHash = new ColorHash();
    var ctx = document.getElementById('myChart');

    var myChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: []
        },
        options: lineOptions
    });

    var myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), heatmapOptions);
    myApexChart.render();

    var legendActive = true;
    document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';


    //------------------------------------------Funciones------------------------------------------------------------------




    function displayLegendButton(value) {
        document.getElementById('btnLegend').style.display = value;
    }

    function displayGroupButton(value) {
        document.getElementById('btnGroupMean').style.display = value;
    }

    function displayGeneralButton(value) {
        document.getElementById('btnMean').style.display = value;
    }

    function displayApexChart(value) {
        document.getElementById('apexchartsDiv').style.display = value;
    }


    function displayChartjs(value) {
        document.getElementById('chart-container').style.display = value;
    }



    function displayChartsButtons(div_id, type) {
        let tabs = document.getElementById(div_id);
        let children = tabs.children;
        for (i = 0; i < children.length; i++) {
            if (children[i].tagName == "INPUT") {
                children[i].style.display = type;
            }

        }
    }

    function disableTab(div_id, noDisable) {

        if (document.getElementById(noDisable).disabled == false) {
            let tabs = document.getElementById(div_id);
            let children = tabs.children;
            for (i = 0; i < children.length; i++) {
                if (children[i].tagName == "INPUT") {
                    children[i].disabled = false;
                }

            }
            document.getElementById(noDisable).disabled = true;
        }


    }


    function updateApexCharts(type, options, series, categories) {
        displayApexChart("block");
        displayChartjs("none");
        options.series = series;
        options.xaxis.categories = categories;
        if (myApexChart.w.config.chart.type == type) {

            myApexChart.updateOptions(options);
        } else {

            myApexChart.destroy();
            myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), options);
            myApexChart.render();
        }
    }

    function updateChartjs(type, dataset, options) {
        displayApexChart("none");
        displayChartjs("block");


        if (myChart.config.type == type) {
            myChart.data = dataset;
            myChart.options = options;
            myChart.update();
            myChart.options.legend.display = legendActive;
            myChart.update();
        } else {
            myChart.destroy();
            myChart = new Chart(ctx, {
                type: type,
                data: dataset,
                options: options
            });
        }





    }

    function updateStackedChart(dataset) {

        disableTab("log_tabs", "btnStackedBar");

        displayLegendButton("inline");
        displayGroupButton("none");
        displayGeneralButton("none");

        updateChartjs("bar", dataset, stackedbarOptions);


    }

    function updateHeatmap(categories, series) {
        disableTab("log_tabs", "btnHeatmap");


        displayLegendButton("none");
        displayGroupButton("none");
        displayGeneralButton("none");



        updateApexCharts("heatmap", heatmapOptions, series, categories);

    }



    function updateLine(dataset) {
        disableTab("grade_tabs", "btnLine");


        displayLegendButton("inline");
        displayGroupButton("none");
        displayGeneralButton("inline");



        updateChartjs("line", dataset, lineOptions);

    }

    function updateRadar(dataset) {
        disableTab("grade_tabs", "btnRadar");


        displayLegendButton("inline");
        displayGroupButton("none");
        displayGeneralButton("none");



        updateChartjs("radar", dataset, radarOptions);

    }




    function clearChartjs() {
        myChart.destroy();
        myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: []
            },
            options: stackedbarOptions
        });
    }


    function manageButtons(type) {


        displayChartsButtons("grade_tabs", type == "grade" ? "inline" : "none");
        displayChartsButtons("log_tabs", type == "log" ? "inline" : "none");

    }



    function changeYMaxStackedBar(max) {
        stackedbarOptions.scales.yAxes[0].ticks.suggestedMax = max;

        myChart.options.scales.yAxes[0].ticks.suggestedMax = max;
        myChart.update();

    }

    function changeYMaxHeatmap(max) {
        heatmapOptions.plotOptions.heatmap.colorScale.ranges = [{
            from: -1,
            to: 0,
            color: "#f78880",
            name: "0"
        }, {
            from: 1,
            to: Math.max(Math.floor(max * 0.25), 1),
            color: "#f4e3ae",
        }, {
            from: Math.max(Math.ceil(max * 0.25), 1),
            to: Math.max(Math.floor(max * 0.50), 1),
            color: "#fff033",

        },

        {
            from: Math.max(Math.ceil(max * 0.50), 1),
            to: Math.max(Math.floor(max * 0.75), 1),
            color: "#b5ff33",

        }, {
            from: Math.max(Math.ceil(max * 0.75), 1),
            to: Math.max(max, Math.floor(max * 0.75)),
            color: "#38e330",

        }, {
            from: max + 1,
            to: Number.POSITIVE_INFINITY,
            color: "#67b92e",
            name: "+" + (max + 1)
        }

        ];
        myApexChart.updateOptions(heatmapOptions);
    }

    //Funcion que muestra u oculta la leyenda del gráfico
    function hideLegend() {
        legendActive = !legendActive;
        if (legendActive) {
            document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';

        } else {
            document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility_off.png)';
        }
    }


    function hideLegendChartjs() {
        hideLegend();
        Chart.defaults.global.legend.display = legendActive;
        myChart.options.legend.display = legendActive;
        myChart.update();
    }


    function hideLegendApexCharts(option) {
        hideLegend();
        option.legend.show = legendActive;
        myApexChart.updateOptions(option);
    }


    function exportChartjs() {
        return myChart.toBase64Image();
    }

    function exportApexcharts() {

        myApexChart.dataURI().then(function (uri) {
            javaConnector.saveImage(uri);
        }).catch(function (error) {
            javaConnector.showErrorWindow("Cannot download image:" + error.message);
        })

    }



    function colorRGB(color) {
        let colors = colorHash.rgb(color);
        return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
    }

    function colorRGBA(color, alpha) {
        let colors = colorHash.rgb(color);
        return "rgba(" + colors[0] + "," + colors[1] + "," + colors[2] + "," + alpha + ")";
    }
    //Funcion que devuelve un color en formato hexadecimal
    //en base a el string que se le pasa
    function colorHEX(color) {
        return colorHash.hex(color);
    }

    // Plugin que nos permite establecer el color de fondo del gráfico
    // el color se define en opciones->chartArea->backgroundColor
    Chart.pluginService.register({
        beforeDraw: function (chart, easing) {
            if (chart.config.options.chartArea && chart.config.options.chartArea.backgroundColor) {
                var helpers = Chart.helpers;
                var ctx = chart.chart.ctx;
                var canvas = document.getElementById('myChart');

                ctx.save();
                ctx.fillStyle = chart.config.options.chartArea.backgroundColor;
                ctx.fillRect(0, 0, canvas.scrollWidth, canvas.scrollHeight);
                ctx.restore();
            }
        }
    });
</script>

</body>

</html>