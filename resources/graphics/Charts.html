<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <title>Charts</title>
    <link rel="stylesheet" type="text/css" href="../css/chart.css" />

    <script type="text/javascript" src="./lib/Chart.js"></script>
    <script type="text/javascript" src="./lib/color-hash.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="./lib/html2canvas.js"></script>
    <script type="text/javascript" src="./messages.js"></script>
    <script type="text/javascript" src="./lib/apexcharts.js"></script>
</head>

<div class="controles">
    <div class="pestañas" id="grade_tabs">
        <input type="button" class="btn" id="btnLineas" onclick="generateChart('line')" />
        <input type="button" class="btn" id="btnRadar" onclick="generateChart('radar')" />
        <input type="button" class="btn" id="btnBoxPlot" onclick="generateChart('boxplot')" />
        <input type="button" class="btn" id="btnBoxPlotGroup" onclick="generateChart('boxplotgroup')" />
        <input type="button" class="btn" id="btnCalificaciones" onclick="drawTable()" />
    </div>
    <div class="pestañas" id="log_tabs">
        <input type="button" class="btn" id="btnStackedBar" onclick="javaConnector.updateStackedBar()" />
        <input type="button" class="btn" id="btnHeatmap" onclick="javaConnector.updateHeatmap()" />
    </div>

    <div class="opciones">
        <input type="button" value="." class="btn" style="visibility: hidden; width: 0px; margin: 0px; padding: 0px;" />
        <input type="button" value="Leyenda" class="btn" id="btnLegend" onclick="hideLegend()" />
        <input type="button" value="Media General" class="btn" id="btnMean" onclick="showGeneralMean()" />
        <input type="button" class="btn" id="btnGroupMean" onclick="showGroupMean()" />
    </div>
</div>

<div id="chart-container" class="chart-container">
    <canvas id="myChart"></canvas>
</div>
<div id="apexchartsDiv" style="display: none;"></div>

<div id="table_div" class="table_div"></div>

<div id="table_img" style="display: none;"></div>

<script type="text/javascript">
    //------------------------------------------Opciones para los graficos------------------------------------------------------------------
    // Opciones Globales
    //Chart.defaults.global.defaultFontFamily= "Comic Sans MS";
    //Chart.defaults.global.defaultFontSize=14;

    // Opciones para el gráfico de lineas y el boxplot
    var optionsLineChart = {
            maintainAspectRatio: false,

            responsiveAnimationDuration: 0, // animation duration after a resize, better perfomance at 0
            showLines: true,
            spanGaps: false, //si se quiere mostrar las lineas cuando en algun elemento no hay dato (NaN)
            animation: {
                duration: 0 // better performance at 0
            }, //animation
            layout: {
                padding: {
                    top: 20,
                } //pading
            }, //layout
            elements: {
                point: {
                    pointStyle: 'circle',
                    radius: 5,
                    hoverRadius: 7
                }, //points
                line: {
                    tension: 0 //at 0 disable bezier curves, better performance
                }
            }, //elements
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    fontSize: 12,
                    fontColor: 'rgba(0, 0, 0, 1)',
                    fontFamily: 'sans-serif'
                } //labels
            }, //legend
            tooltips: {
                mode: 'index',
                intersect: false,
                position: 'average',
                backgroundColor: 'rgba(0, 0, 0, 1)',
                bodySpacing: 4,
                cornerRadius: 0,
                caretSize: 10,
                itemSort: function(a, b) {
                    return (parseFloat(a.y) - parseFloat(b.y));
                }
            }, //tooltips
            scales: {
                yAxes: [{
                    id: 'left-y-axis',
                    type: 'linear',
                    position: 'left',
                    gridLines: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.4)'
                    }, //gridLines
                    ticks: {
                        beginAtZero: true,
                        max: 10,
                        stepSize: 1,
                        fontColor: 'rgba(0, 0, 0, 1)'
                    } //ticks
                }, {
                    id: 'right-y-axis',
                    type: 'linear',
                    position: 'right',
                    gridLines: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.4)'
                    }, //gridLines
                    ticks: {
                        beginAtZero: true,
                        max: 10,
                        stepSize: 1,
                        fontColor: 'rgba(0, 0, 0, 1)'
                    } //ticks
                }], //yAxes
                xAxes: [{
                        gridLines: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.4)'
                        }, //gridLines
                        ticks: {
                            autoSkip: false,
                            fontColor: 'rgba(0, 0, 0, 1)'
                        }
                    }] //xAxes
            }, //scales
            chartArea: {
                backgroundColor: 'rgba(255,255,255,1)'
            } //chartArea
        } //options

    // Opciones para el radar
    var optionsRadarChart = {
            maintainAspectRatio: false,

            responsiveAnimationDuration: 0, // animation duration after a resize, better perfomance at 0
            showLines: true,
            spanGaps: false, //si se quiere mostrar las lineas cuando en algun elemento no hay dato (NaN)
            animation: {
                duration: 0 // better performance at 0
            }, //animation
            layout: {
                padding: {
                    top: 20,
                } //pading
            }, //layout
            elements: {
                point: {
                    pointStyle: 'circle',
                    radius: 5,
                    hoverRadius: 7
                }, //points
                line: {
                    tension: 0 //disable bezier curves, better performance
                }
            }, //elements
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    fontSize: 12,
                    fontColor: 'rgba(0, 0, 0, 1)',
                    fontFamily: 'sans-serif'
                } //labels
            }, //legend
            tooltips: {
                mode: 'index',
                intersect: true,
                position: 'average',
                backgroundColor: 'rgba(0, 0, 0, 1)',
                bodySpacing: 4,
                cornerRadius: 0,
                caretSize: 10,
                itemSort: function(a, b) {
                    return (parseFloat(a.y) - parseFloat(b.y));
                }
            }, //tooltips
            scale: {
                gridLines: {
                    display: true,
                    color: 'rgba(0, 0, 0, 0.4)'
                }, //gridLines
                ticks: {
                    beginAtZero: true,
                    suggestedMax: 10,
                    stepSize: 1,
                    fontColor: 'rgba(0, 0, 0, 1)'
                } //ticks
            }, //scales
            chartArea: {
                backgroundColor: 'rgba(255,255,255,1)'
            } //chartArea
        } //options

    var optionsStackedBar = {
        maintainAspectRatio: false,

        animation: {
            duration: 0, // general animation time
        },
        elements: {
            line: {
                tension: 0 //at 0 disable bezier curves, better performance
            }
        }, //elements
        tooltips: {
            position: 'nearest',
            mode: 'x',
            itemSort: function(a, b) {
                return b.yLabel - a.yLabel;
            },
            callbacks: {
                label: function(tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + " : " + Math.round(tooltipItem.yLabel *
                        100) / 100;
                },
                afterTitle: function(tooltipItem, data) {
                    //Despues del titulo ponemos el nombre y apellidos del usuario
                    return data.datasets[tooltipItem[0].datasetIndex].name;
                }
            }
        },
        scales: {
            yAxes: [{
                stacked: true,
                ticks: {
                    beginAtZero: true,
                    min: 0,
                }
            }]
        },
        legend: {
            display: true,
            position: 'bottom',
            labels: {
                padding: 20,
                usePointStyle: true,
                fontSize: 12,
                fontColor: 'rgba(0, 0, 0, 1)',
                fontFamily: 'sans-serif',
                filter: function(legendItem, chartData) {
                        //mostramos en la leyenda los que son lineas
                        return chartData.datasets[legendItem.datasetIndex].type == "line";
                    } //filter
            } //labels
        } //legend

    }

    heatmapOptions = {
            tooltip: {
                x: {
                    show: true
                }
            },
            plotOptions: {
                heatmap: {
                    enableShades: false,
                    //shadeIntensity: 0.5,
                    colorScale: {
                        ranges: [{
                            from: -1,
                            to: 0,
                            color: "#f78880",
                            name: "0"
                        }, {
                            from: 1,
                            to: 1,
                            color: "#f4e3ae",
                        }, {
                            from: 1,
                            to: 1,
                            color: "#fff033",

                        },

                        {
                            from: 1,
                            to: 1,
                            color: "#b5ff33",

                        }, {
                            from: 1,
                            to: 1,
                            color: "#38e330",

                        }, {
                            from: 2,
                            to: Number.POSITIVE_INFINITY,
                            color: "#67b92e",
                            name: "+" + (2)
                        }

                    ]
                }
            }
        },
        legend: {
            position: 'bottom'
        },
        chart: {
            toolbar: {
                show: false,
            },
            animations: {
                enabled: false
            },
            type: "heatmap"
        },
        dataLabels: {
            formatter: function(val, opts) {
                if (val == 0) {
                    return "";
                }
                return val;
            },
            style: {
                colors: ["#000000"]
            }
        },
        colors: ["#00A100"],
        series: [],
        xaxis: {
            categories: []
        }
    };

    //------------------------------------------Variables globales-------------------------------------------------------------

    var language = 'es';

    //
    var colorHash = new ColorHash();
    var ctx = document.getElementById('myChart');

    var myChart = new Chart(ctx,{
        data: {
            labels: [],
            datasets: []
        },
        options: {
        }
    });

    var myApexChart = new ApexCharts(document.getElementById('apexchartsDiv'), heatmapOptions);
    myApexChart.render();
    // Cargamos la librearia de google para la tabla de calificaciones
    google.charts.load('current', {
        'packages': ['table']
    });
    var table;

    document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';


    //------------------------------------------Funciones------------------------------------------------------------------

    
    
    
    function displayLegendButton(value){
    	document.getElementById('btnLegend').style.display = value;
    }
    
    function displayGroupButton(value){
    	document.getElementById('btnGroupMean').style.display = value;
    }
    
    function displayGeneralButton(value){
    	document.getElementById('btnMean').style.display = value;
    }
    
    function displayApexChart(value){
    	document.getElementById('apexchartsDiv').style.display = value;
    }
    
    function displayTable(value){
        document.getElementById('table_div').style.display = value;
    }
    
    function displayChartjs(value){
    	document.getElementById('chart-container').style.display = value;
    }
    
    function updateChartjs(update, type, dataset, options){
    	
    	if (update){
        	myChart.data = dataset;
        }else{
        	myChart.destroy();
            myChart = new Chart(ctx, {
                type: type,
                data: dataset,
                options: options
              });
        }
        myChart.update();
    	
    }
    
    
    function updateStackedChart(dataset, update){

        document.getElementById('btnHeatmap').disabled = false;
        document.getElementById('btnStackedBar').disabled = true;
        
        displayTable("none");
        displayApexChart("none");
        displayChartjs("block");
        
        displayLegendButton("none");
        displayGroupButton("none");
        displayGeneralButton("none");
        
        updateChartjs(update, "bar", dataset, optionsStackedBar);
        
        
    }
    
    
    function updateHeatmap(categories, series) {
        document.getElementById('btnHeatmap').disabled = true;
        document.getElementById('btnStackedBar').disabled = false;
        displayTable("none");
        displayApexChart("block");
        displayChartjs("none");
        
        displayLegendButton("none");
        displayGroupButton("none");
        displayGeneralButton("none");
        

        heatmapOptions.series = series;
        heatmapOptions.xaxis.categories = categories;
        heatmapOptions.chart.height = document.documentElement.clientHeight - 55;
        myApexChart.updateOptions(heatmapOptions);
    }

    function manageButtons(type) {

        let types = {
            grade: type == "grade" ? "inline" : "none",
            log: type == "log" ? "inline" : "none"
        };

        document.getElementById('btnLineas').style.display = types.grade;
        document.getElementById('btnRadar').style.display = types.grade;
        document.getElementById('btnBoxPlot').style.display = types.grade;
        document.getElementById('btnBoxPlotGroup').style.display = types.grade;
        document.getElementById('btnCalificaciones').style.display = types.grade;

        document.getElementById('btnStackedBar').style.display = types.log;
        document.getElementById('btnHeatmap').style.display = types.log;

    }

    function changeYMaxStackedBar(max) {
        optionsStackedBar.scales.yAxes[0].ticks.suggestedMax = max;

        myChart.options.scales.yAxes[0].ticks.suggestedMax = max;
        myChart.update();

    }

    function changeYMaxHeatmap(max) {
        heatmapOptions.plotOptions.heatmap.colorScale.ranges = [{
                from: -1,
                to: 0,
                color: "#f78880",
                name: "0"
            }, {
                from: 1,
                to: Math.max(Math.ceil(max * 0.25),1),
                color: "#f4e3ae",
            }, {
                from: Math.max(Math.floor(max * 0.25),1),
                to: Math.max(Math.ceil(max * 0.50),1),
                color: "#fff033",

            },

            {
                from: Math.max(Math.floor(max * 0.50), 1),
                to: Math.max(Math.ceil(max * 0.75),1),
                color: "#b5ff33",

            }, {
                from: Math.max(Math.floor(max * 0.75),1),
                to: Math.max(max, Math.ceil(max * 0.75)),
                color: "#38e330",

            }, {
                from: max + 1,
                to: Number.POSITIVE_INFINITY,
                color: "#67b92e",
                name: "+" + (max + 1)
            }

        ];
        myApexChart.updateOptions(heatmapOptions);
    }

    //Funcion que muestra u oculta la leyenda del gráfico
    function hideLegend() {
        if (legendActive == true) {
            legendActive = false;
            myChart.options.legend.display = false;
            myChart.update();
            document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility_off.png)';
        } else {
            legendActive = true;
            myChart.options.legend.display = true;
            myChart.update();
            document.getElementById('btnLegend').style.backgroundImage = 'url(./../img/visibility.png)';
        }
    }
    //Funcion que devuelve un color en formato 'rgba(r,g,b', a falta de la transpaerncia
    //en base a el string que se le pasa
    function colorRGB(color) {
        var rgbaColor = 'rgba(';
        var colors = []
        colors = colorHash.rgb(color);
        for (i = 0; i < colors.length; i++) {
            rgbaColor += colors[i] + ',';
        }
        return rgbaColor;
    }
    //Funcion que devuelve un color en formato hexadecimal
    //en base a el string que se le pasa
    function colorHEX(color) {
        return colorHash.hex(color);
    }
    // Exporta el elemento actual
    function exportCurrentElemet() {
        if (currentType == 'table') {
            return document.querySelector('#table_img canvas').toDataURL();
        } else {
            myChart.update(); // por algun motivo si no se actualiza no cambia la grafica elegida
            return myChart.toBase64Image();
        }
    }

    // Plugin que nos permite establecer el color de fondo del gráfico
    // el color se define en opciones->chartArea->backgroundColor
    Chart.pluginService.register({
        beforeDraw: function(chart, easing) {
            if (chart.config.options.chartArea && chart.config.options.chartArea.backgroundColor) {
                var helpers = Chart.helpers;
                var ctx = chart.chart.ctx;
                var canvas = document.getElementById('myChart');

                ctx.save();
                ctx.fillStyle = chart.config.options.chartArea.backgroundColor;
                ctx.fillRect(0, 0, canvas.scrollWidth, canvas.scrollHeight);
                ctx.restore();
            }
        }
    });
</script>

</body>

</html>